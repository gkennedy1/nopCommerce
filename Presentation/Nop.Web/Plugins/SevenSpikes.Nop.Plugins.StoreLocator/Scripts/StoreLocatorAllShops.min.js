/*
* Copyright 2015 Seven Spikes Ltd. All rights reserved. (http://www.nop-templates.com)
* http://www.nop-templates.com/t/licensinginfo
*/

function loadMapScript() { var e = document.createElement("script"); e.src = "https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=places&sensor=false&callback=initializeMap", document.body.appendChild(e) } function initializeMap() { var e = document.getElementById(mapWrapperId), t = { center: new google.maps.LatLng(shopX, shopY), zoom: 15, mapTypeId: google.maps.MapTypeId.ROADMAP }; map = new google.maps.Map(e, t), google.maps.event.addListenerOnce(map, "idle", function () { onMapLoad(), createMapSearchBox() }) } function onMapLoad() { bounds = new google.maps.LatLngBounds; for (var e = 0; e < allShops.length; e++) addMarker(allShops[e], !1); allShops.length > 1 && map.fitBounds(bounds), directionsService = new google.maps.DirectionsService, directionsDisplay = new google.maps.DirectionsRenderer, directionsDisplay.setPanel(document.getElementById("directions-panel")), $(".getUserGeoLocation").on("click", function (e) { e.preventDefault(), getUserGeoLocation() }) } function addMarker(e, t) { if (null != e.lat && null != e.lng && patternCoords.test(e.lat) && patternCoords.test(e.lng)) { var a = new google.maps.LatLng(e.lat, e.lng), s = new google.maps.Marker({ position: a, map: map, title: e.title, draggable: t }); bounds.extend(a), map.setCenter(a), s.setMap(map), markers.push(s); var o = new google.maps.InfoWindow({ maxWidth: 400, content: "<h5>" + e.title + "</h5><div>" + $(".shops-list > li:eq(" + e.index + ") .short-description").html() + "</div>" }); google.maps.event.addListener(s, "click", function () { o.open(map, s), $(".shops-list > li").removeClass("active"), $('.shops-list > li[data-ind="' + e.index + '"]').addClass("active") }) } } function setAllMap(e) { for (var t = 0; t < markers.length; t++) markers[t].setMap(e) } function clearMarkers() { setAllMap(null) } function showMarkers() { setAllMap(map) } function deleteMarkers() { clearMarkers(), markers = [] } function createMapSearchBox() { var e = document.getElementById("shop-address-input"); map.controls[google.maps.ControlPosition.TOP_LEFT].push(e); var t = new google.maps.places.SearchBox(e); e.style.display = "block", google.maps.event.addListener(t, "places_changed", function () { var e = t.getPlaces(); 0 != e.length && (createUserMarker(e[0].geometry.location), userMarker.setPosition(e[0].geometry.location), map.setCenter(e[0].geometry.location), searchResultCoords = e[0].geometry.location, showDistancesFromShopsToUser()) }) } function createUserMarker(e) { if (!isUserMarkerCreated) { var t = $(".shop-resources").attr("data-pathtoimages") + "/squat_marker_green_thumb.png", a = new google.maps.Marker({ position: e, map: map, icon: t, animation: google.maps.Animation.DROP, title: $(".shop-resources").attr("data-youarehere"), draggable: !0 }); a.setMap(map), userMarker = a, bounds.extend(e), $(".distanceAndDirections").show(), $('#sortingSelect option[value="sortbydistance"]').removeAttr("disabled"), isUserMarkerCreated = !0, google.maps.event.addListener(a, "dragend", function () { showMarkers(), $(".shops-list > li").show(), showDistancesFromShopsToUser() }) } } function getUserGeoLocation() { var e = "Geolocation is not supported by this browser."; return navigator.geolocation && navigator.geolocation.getCurrentPosition(function (t) { e = "Now we use your current position. ( Maybe a confirmation is required by the browser to use it. )"; var a = new google.maps.LatLng(t.coords.latitude, t.coords.longitude); createUserMarker(a), userMarker.setPosition(a), map.setCenter(a), showDistancesFromShopsToUser() }), e } function showDirectionsToShop(e) { if (null != markers[e]) { var t = "Imperial" == $(".shop-resources").attr("data-units"), a = { origin: new google.maps.LatLng(userMarker.position.lat(), userMarker.position.lng()), destination: new google.maps.LatLng(markers[e].position.lat(), markers[e].position.lng()), travelMode: google.maps.TravelMode.DRIVING, unitSystem: t ? google.maps.UnitSystem.IMPERIAL : google.maps.UnitSystem.METRIC }; directionsService.route(a, function (e, t) { t == google.maps.DirectionsStatus.OK && (directionsDisplay.setMap(map), directionsDisplay.setDirections(e)), $("#directions-panel, .map-wrapper, #backToResults").addClass("directions-shown") }) } } function showDistancesFromShopsToUser() { $(".shops-list > li").each(function () { var e = $(this), t = e.attr("data-ind"); null != markers[t] && getDistanceToPosition(markers[t].position, e) }), $('#sortingSelect option[value="sortbydistance"]').attr("selected", "selected"), sortShopsByDistance() } function getDistanceToPosition(e, t) { var a = "Imperial" == $(".shop-resources").attr("data-units"), s = 6371e3, o = Math.toRadians(userMarker.position.lat()), r = Math.toRadians(userMarker.position.lng()), n = Math.toRadians(e.lat()), i = Math.toRadians(e.lng()), l = n - o, p = i - r, c = Math.sin(l / 2) * Math.sin(l / 2) + Math.cos(o) * Math.cos(n) * Math.sin(p / 2) * Math.sin(p / 2), d = 2 * Math.atan2(Math.sqrt(c), Math.sqrt(1 - c)), h = s * d / 1e3; a ? (t.find(".distance-value").html(Math.round(.621371192 * h) + " mi."), t.find(".distanceToShopValue").val(.621371192 * h)) : (t.find(".distance-value").html(Math.round(h) + " km."), t.find(".distanceToShopValue").val(h)) } function sortShopsBySelectedMethod() { var e = $("#sortingSelect").val(); "sortbydistance" == e ? sortShopsByDistance() : "sortbyname" == e ? sortShopsByName() : "sortbyid" == e && sortShopsById() } function sortShopsByName() { var e = $(".shops-list > li"); e.sort(function (e, t) { var a = $(e).find(".shop-name").html(), s = $(t).find(".shop-name").html(); return a.localeCompare(s) }), $(".shops-list").html(e) } function sortShopsByDistance() { if (isUserMarkerCreated) { var e = $(".shops-list > li"); e.sort(function (e, t) { var a = parseFloat($(e).find(".distanceToShopValue").val()), s = parseFloat($(t).find(".distanceToShopValue").val()); return a - s }), $(".shops-list").html(e) } } function sortShopsById() { if (isUserMarkerCreated) { var e = $(".shops-list > li"); e.sort(function (e, t) { var a = parseInt($(e).attr("data-ind")), s = parseInt($(t).attr("data-ind")); return a - s }), $(".shops-list").html(e) } } function searchForShopsMatchingTheSearchCriteria() { var e = isUserMarkerCreated, t = $("#searchByTagsInput").val(), a = t.length > 2, s = parseFloat($("#searchRadius").val()); isNaN(s) && (e = !1), (e || a) && ($(".shops-list > li").each(function () { var o = $(this), r = parseInt(o.attr("data-ind")), n = !0, i = !0; if (e) { var l = parseFloat(o.find(".distanceToShopValue").val()); l > s && (n = !1) } if (a) { var p = o.find(".shop-tags-hidden-field").val(); (void 0 == p || -1 == p.indexOf(t)) && (i = !1) } n && i ? (o.show(), null != markers[r] && markers[r].setMap(map)) : (o.hide(), null != markers[r] && markers[r].setMap(null)) }), 0 == $(".shops-list > li:visible").length ? $(".no-shops-after-filtering").show() : $(".no-shops-after-filtering").hide(), sortShopsBySelectedMethod()) } var mapWrapperId = "all-shops-map-holder", shopCoordinatesElementClass = ".shop-coordinates", allShops = [], directionsService, directionsDisplay, map, markers = [], userMarker, bounds, searchResultCoords, shopX = 0, shopY = 0, patternCoords = new RegExp(/^-?\d+\.?\d*$/), isUserMarkerCreated = !1; $(document).ready(function () { $(shopCoordinatesElementClass).length > 0 && null != document.getElementById(mapWrapperId) && ($(shopCoordinatesElementClass).each(function (e) { var t = $(this).attr("data-latitude"), a = $(this).attr("data-longitude"), s = { index: e, lat: t, lng: a, title: $(this).attr("data-shop-title") }; allShops.push(s) }), loadMapScript(), $("#backToResults").on("click", function () { directionsDisplay.setMap(null), $("#directions-panel, .map-wrapper, #backToResults").removeClass("directions-shown") }), $("#searchForFilteredShops").on("click", function (e) { e.preventDefault(), searchForShopsMatchingTheSearchCriteria(), $("#clearShopFilters").show() }), $(".shops-list").on("click", ".show-directions", function (e) { if (e.preventDefault(), isUserMarkerCreated) { var t = parseInt($(this).parents("li.shops-item").attr("data-ind")); t >= 0 && showDirectionsToShop(t) } }), $(".shops-list").on("mouseenter", "li", function () { var e = markers[$(this).attr("data-ind")]; null != e && e.setAnimation(google.maps.Animation.BOUNCE) }).on("mouseleave", "li", function () { var e = markers[$(this).attr("data-ind")]; null != e && e.setAnimation(null) }), $("#clearShopFilters").on("click", function () { showMarkers(), $(".shops-list > li").show(), $("#searchByTagsInput").val(""), $("#searchRadius").val(""), $(this).hide() }), $("#sortingSelect").on("change", sortShopsBySelectedMethod), $(".align-map-button").on("click", function () { map.fitBounds(bounds) })) }), Math.toRadians = function (e) { return e * Math.PI / 180 };
